<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImgPath - Image Navigation Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    <script>
const APP_URL = window.location.origin;
let state = {
    screen: 'home',
    apiKey: '',
    currentImage: '',
    targetImage: '',
    targetName: '',
    results: [],
    labels: [],
    moves: 0,
    time: 0,
    timerInterval: null,
    gameWon: false,
    gameMode: '',
    showGiveUp: false,
    showLens: false,
    isDragging: false,
    dragStart: null,
    cropBox: null,
    campaignLevel: 1,
    completedLevels: []
};

const challenges = [
    { id: 1, start: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800', target: 'https://images.unsplash.com/photo-1485871981521-5b1fd3805eee?w=800', targetName: 'Statue of Liberty' },
    { id: 2, start: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800', target: 'https://images.unsplash.com/photo-1502602898657-3e91760cbb34?w=800', targetName: 'Eiffel Tower' },
    { id: 3, start: 'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=800', target: 'https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=800', targetName: 'Big Ben' }
];

function render() {
    const app = document.getElementById('app');
    
    if (state.screen === 'home') {
        app.innerHTML = `
            <div class="min-h-screen bg-gray-50 p-4">
                <div class="max-w-2xl mx-auto pt-12">
                    <div class="text-center mb-12">
                        <h1 class="text-6xl font-bold text-gray-800 tracking-tight mb-2">ImgPath</h1>
                    </div>
                    <div class="space-y-3">
                        <button onclick="startGame('quick')" class="w-full p-5 text-white rounded-xl flex items-center gap-4 transition-all hover:opacity-90" style="background-color: #6aaa64">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">‚ñ∂</div>
                            <div class="flex-1 text-left"><div class="font-bold text-lg">Quick Play</div><div class="text-sm opacity-90">Jump right in</div></div>
                        </button>
                        <button onclick="showScreen('campaign')" class="w-full p-5 text-white rounded-xl flex items-center gap-4 transition-all hover:opacity-90" style="background-color: #445e93">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">‚ñ¶</div>
                            <div class="flex-1 text-left"><div class="font-bold text-lg">Journey Mode</div><div class="text-sm opacity-90">Progress through levels</div></div>
                        </button>
                        <button class="w-full p-5 text-white rounded-xl flex items-center gap-4 cursor-not-allowed" style="background-color: #f1c40f">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">üë•</div>
                            <div class="flex-1 text-left"><div class="font-bold text-lg">Multiplayer</div><div class="text-sm opacity-90">Race against others</div></div>
                        </button>
                        <button class="w-full p-5 text-white rounded-xl flex items-center gap-4 cursor-not-allowed" style="background-color: #e8a0a0">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">üìÖ</div>
                            <div class="flex-1 text-left"><div class="font-bold text-lg">Daily Challenge</div><div class="text-sm opacity-90">Today's puzzle</div></div>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-8">
                        <button onclick="showScreen('achievements')" class="flex items-center justify-center gap-2 p-4 bg-white border-2 border-gray-200 rounded-xl hover:border-gray-300">
                            <span class="text-2xl">üèÜ</span><span class="font-semibold text-gray-700">Achievements</span>
                        </button>
                        <button onclick="showScreen('stats')" class="flex items-center justify-center gap-2 p-4 bg-white border-2 border-gray-200 rounded-xl hover:border-gray-300">
                            <span class="text-2xl">üìä</span><span class="font-semibold text-gray-700">Stats</span>
                        </button>
                    </div>
                    <div class="mt-4">
                        <button onclick="showScreen('about')" class="w-full p-4 bg-white border-2 border-gray-200 rounded-xl hover:border-gray-300 font-semibold text-gray-700">About</button>
                    </div>
                </div>
            </div>
        `;
    } else if (state.screen === 'setup') {
        app.innerHTML = `
            <div class="min-h-screen bg-gray-50 p-4 flex items-center justify-center">
                <div class="max-w-md w-full bg-white rounded-2xl p-8 shadow-xl border-2 border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Enter API Key</h2>
                    <p class="text-gray-600 text-center mb-6">You need a Google Vision API key to play</p>
                    <input type="password" id="api-key-input" value="${state.apiKey}" placeholder="Paste your API key here..." class="w-full p-4 border-2 border-gray-300 rounded-lg mb-4 focus:border-blue-500 focus:outline-none font-mono text-sm">
                    <button onclick="saveApiKey()" class="w-full bg-green-500 text-white font-bold py-4 rounded-lg hover:bg-green-600 mb-4" style="background-color: #6aaa64">Start Playing</button>
                    <button onclick="showScreen('home')" class="w-full text-gray-600 hover:text-gray-800 font-medium">‚Üê Back</button>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-900 font-medium mb-2">Don't have an API key?</p>
                        <p class="text-xs text-blue-700 mb-2">Get one free at <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="underline font-semibold">Google Cloud Console</a></p>
                        <p class="text-xs text-blue-700">Enable "Cloud Vision API" and create an API key. Free tier includes 1,000 requests/month.</p>
                    </div>
                </div>
            </div>
        `;
    } else if (state.screen === 'campaign') {
        const colors = ['#6aaa64', '#445e93', '#f1c40f', '#e8a0a0'];
        const gridHTML = challenges.map((c, i) => `
            <button onclick="startCampaignLevel(${c.id})" class="aspect-square rounded-xl text-white font-bold text-2xl flex items-center justify-center transition-all hover:opacity-90 ${state.completedLevels.includes(c.id) ? 'opacity-100' : 'opacity-100'}" style="background-color: ${colors[i % colors.length]}">
                ${c.id}${state.completedLevels.includes(c.id) ? ' ‚úì' : ''}
            </button>
        `).join('');
        
        app.innerHTML = `
            <div class="min-h-screen bg-gray-50 p-4">
                <div class="max-w-3xl mx-auto pt-8">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="showScreen('home')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        <h2 class="text-3xl font-bold text-gray-800">Journey Mode</h2>
                        <div class="w-20"></div>
                    </div>
                    <div class="grid grid-cols-4 gap-3">${gridHTML}</div>
                </div>
            </div>
        `;
    } else if (state.screen === 'about') {
        app.innerHTML = `
            <div class="min-h-screen bg-gray-50 p-4">
                <div class="max-w-2xl mx-auto pt-8">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="showScreen('home')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        <h2 class="text-3xl font-bold text-gray-800">About</h2>
                        <div class="w-20"></div>
                    </div>
                    <div class="bg-white rounded-2xl p-8 border-2 border-gray-200 space-y-6">
                        <div><h3 class="text-xl font-bold text-gray-800 mb-3">How to Play</h3><ul class="space-y-2 text-gray-700"><li>‚Ä¢ Each round shows you a target image and a starting image</li><li>‚Ä¢ Click on similar images to navigate closer to your target</li><li>‚Ä¢ Use the lens tool to search specific regions</li><li>‚Ä¢ Reach the target in as few moves and as quickly as possible</li></ul></div>
                    </div>
                </div>
            </div>
        `;
    } else if (state.screen === 'achievements') {
        app.innerHTML = `
            <div class="min-h-screen bg-gray-50 p-4">
                <div class="max-w-3xl mx-auto pt-8">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="showScreen('home')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        <h2 class="text-3xl font-bold text-gray-800">Achievements</h2>
                        <div class="w-20"></div>
                    </div>
                    <div class="space-y-3">
                        <div class="p-4 rounded-xl border-2 bg-white border-yellow-400 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center bg-yellow-400"><span class="text-2xl">üèÜ</span></div>
                            <div class="flex-1"><h3 class="font-bold text-gray-800">First Victory</h3><p class="text-sm text-gray-600">Win your first game</p></div>
                            <div class="text-sm font-semibold text-gray-700">+50 XP</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (state.screen === 'stats') {
        app.innerHTML = `
            <div class="min-h-screen bg-gray-50 p-4">
                <div class="max-w-3xl mx-auto pt-8">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="showScreen('home')" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
                        <h2 class="text-3xl font-bold text-gray-800">Your Stats</h2>
                        <div class="w-20"></div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-6 rounded-xl mb-6" style="background: linear-gradient(to right, #6aaa64, #445e93)">
                        <div class="flex items-center justify-between mb-4">
                            <div><div class="text-sm opacity-90">Level</div><div class="text-4xl font-bold">12</div></div>
                            <div class="text-right"><div class="text-sm opacity-90">Total XP</div><div class="text-4xl font-bold">2,450</div></div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full h-3"><div class="bg-white h-3 rounded-full" style="width: 65%"></div></div>
                        <div class="text-sm mt-2 opacity-90">650 / 1000 XP to next level</div>
                    </div>
                </div>
            </div>
        `;
    } else if (state.screen === 'game') {
        const statusClass = state.gameWon ? 'bg-green-500 text-white text-lg' : 'bg-blue-50 text-blue-700';
        const resultsHTML = state.results.map((img, i) => `
            <div onclick="handleImageClick('${img.url}')" class="cursor-pointer rounded-lg overflow-hidden border-2 border-gray-200 hover:border-green-500 hover:scale-105 transition-all" style="border-color: #6aaa64">
                <img src="${img.url}" alt="${img.title || ''}" class="w-full h-32 object-cover" crossorigin="anonymous" onerror="this.parentElement.style.display='none'">
            </div>
        `).join('');
        
        app.innerHTML = `
            <div class="min-h-screen bg-gray-50 flex">
                <!-- SIDEBAR -->
                <div class="w-80 bg-white border-r-2 border-gray-200 p-6 flex flex-col">
                    <!-- Target -->
                    <div class="mb-6">
                        <div class="text-sm font-semibold text-gray-500 mb-2">TARGET</div>
                        <div class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4">
                            <img src="${state.targetImage}" alt="Target" class="w-full h-48 object-cover rounded-lg mb-3">
                            <div class="font-bold text-xl text-yellow-900">${state.targetName}</div>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div class="space-y-3 mb-6">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-xs font-semibold text-gray-500 mb-1">TIME</div>
                            <div class="font-mono font-bold text-2xl text-gray-800">${formatTime(state.time)}</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-xs font-semibold text-gray-500 mb-1">MOVES</div>
                            <div class="font-bold text-2xl text-gray-800">${state.moves}</div>
                        </div>
                    </div>
                    
                    ${state.status ? `<div class="p-3 rounded-xl mb-4 text-center font-semibold ${statusClass}">${state.status}</div>` : ''}
                    
                    <button onclick="showGiveUpDialog()" ${state.gameWon ? 'disabled' : ''} class="w-full px-4 py-3 bg-white border-2 border-red-200 text-red-600 rounded-lg font-semibold hover:border-red-300 ${state.gameWon ? 'opacity-50 cursor-not-allowed' : ''}">
                        Give Up
                    </button>
                </div>
                
                <!-- MAIN CONTENT -->
                <div class="flex-1 p-6 overflow-y-auto">
                    <!-- Current Image -->
                    <div class="bg-white rounded-xl border-2 border-gray-200 p-2 mb-6">
                        <div class="relative" id="image-container">
                            <img id="current-image" src="${state.currentImage}" alt="Current" class="w-full rounded-lg" crossorigin="anonymous">
                            ${state.showLens ? `
                                <div id="crop-overlay" class="absolute inset-0 bg-black bg-opacity-50 cursor-crosshair"></div>
                                <div id="crop-box" class="absolute border-4 border-white shadow-lg" style="display:none"></div>
                            ` : `
                                <button onclick="activateLens()" class="absolute bottom-4 right-4 w-14 h-14 bg-white rounded-full shadow-lg border-2 border-gray-300 flex items-center justify-center hover:scale-110 transition-transform">
                                    <svg class="w-7 h-7 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                                    </svg>
                                </button>
                            `}
                        </div>
                    </div>
                    
                    <!-- Results Grid -->
                    ${state.results.length > 0 ? `
                        <div class="mb-2">
                            <div class="text-sm font-semibold text-gray-600">Found ${state.results.length} images. Click one to continue!</div>
                        </div>
                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">${resultsHTML}</div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // Setup lens crop tool if active
        if (state.showLens) {
            setTimeout(() => setupCropTool(), 100);
        }
    }
    
    if (state.showGiveUp) {
        renderGiveUpDialog();
    }
}

function setupCropTool() {
    const container = document.getElementById('image-container');
    const overlay = document.getElementById('crop-overlay');
    const cropBox = document.getElementById('crop-box');
    
    if (!container || !overlay || !cropBox) return;
    
    let startX, startY;
    
    overlay.addEventListener('mousedown', (e) => {
        const rect = container.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        
        cropBox.style.left = startX + 'px';
        cropBox.style.top = startY + 'px';
        cropBox.style.width = '0px';
        cropBox.style.height = '0px';
        cropBox.style.display = 'block';
        
        state.isDragging = true;
    });
    
    overlay.addEventListener('mousemove', (e) => {
        if (!state.isDragging) return;
        
        const rect = container.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        const left = Math.min(currentX, startX);
        const top = Math.min(currentY, startY);
        
        cropBox.style.left = left + 'px';
        cropBox.style.top = top + 'px';
        cropBox.style.width = width + 'px';
        cropBox.style.height = height + 'px';
    });
    
    overlay.addEventListener('mouseup', async (e) => {
        if (!state.isDragging) return;
        state.isDragging = false;
        
        const rect = container.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        
        if (width > 20 && height > 20) {
            await cropAndSearch(startX, startY, width, height);
        }
        
        state.showLens = false;
        render();
    });
}

async function cropAndSearch(x, y, width, height) {
    const img = document.getElementById('current-image');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const scaleX = img.naturalWidth / img.width;
    const scaleY = img.naturalHeight / img.height;
    
    canvas.width = width * scaleX;
    canvas.height = height * scaleY;
    
    ctx.drawImage(img, x * scaleX, y * scaleY, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
    
    const croppedData = canvas.toDataURL('image/jpeg').split(',')[1];
    await analyzeImage(croppedData);
}

function activateLens() {
    state.showLens = true;
    render();
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function showScreen(screen) {
    state.screen = screen;
    render();
}

function startGame(mode) {
    state.gameMode = mode;
    if (!state.apiKey) {
        state.screen = 'setup';
    } else {
        initGame();
    }
    render();
}

function startCampaignLevel(levelId) {
    const challenge = challenges.find(c => c.id === levelId);
    if (!challenge) return;
    
    state.gameMode = 'campaign';
    state.campaignLevel = levelId;
    
    if (!state.apiKey) {
        state.screen = 'setup';
    } else {
        initGame(challenge.start, challenge.target, challenge.targetName);
    }
    render();
}

function saveApiKey() {
    const input = document.getElementById('api-key-input');
    state.apiKey = input.value.trim();
    if (state.apiKey) {
        localStorage.setItem('imgpath_api_key', state.apiKey);
        initGame();
    }
}

function initGame(startImg, targetImg, targetName) {
    const targets = [
        { img: 'https://images.unsplash.com/photo-1485871981521-5b1fd3805eee?w=800', name: 'Statue of Liberty' },
        { img: 'https://images.unsplash.com/photo-1502602898657-3e91760cbb34?w=800', name: 'Eiffel Tower' },
        { img: 'https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=800', name: 'Big Ben' }
    ];
    
    const target = targetImg ? { img: targetImg, name: targetName } : targets[Math.floor(Math.random() * targets.length)];
    
    state.screen = 'game';
    state.currentImage = startImg || 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800';
    state.targetImage = target.img;
    state.targetName = target.name;
    state.results = [];
    state.labels = [];
    state.moves = 0;
    state.time = 0;
    state.gameWon = false;
    state.showGiveUp = false;
    state.showLens = false;
    state.status = '';
    
    if (state.timerInterval) clearInterval(state.timerInterval);
    state.timerInterval = setInterval(() => {
        state.time++;
        render();
    }, 1000);
    
    render();
    analyzeCurrentImage();
}

async function analyzeCurrentImage() {
    const img = document.getElementById('current-image');
    if (!img) return;
    
    const canvas = document.createElement('canvas');
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg').split(',')[1];
    await analyzeImage(imageData);
}

async function analyzeImage(imageData) {
    try {
        const response = await fetch(`${APP_URL}/api/analyze`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imageData, apiKey: state.apiKey })
        });
        
        const data = await response.json();
        
        if (data.error) {
            state.status = data.error;
            render();
            return;
        }
        
        const result = data.responses[0];
        state.labels = result.labelAnnotations?.map(l => l.description) || [];
        
        // Check for win
        const targetLower = state.targetName.toLowerCase();
        const foundTarget = state.labels.some(label => 
            label.toLowerCase().includes(targetLower) || 
            targetLower.includes(label.toLowerCase())
        );
        
        if (foundTarget) {
            state.gameWon = true;
            clearInterval(state.timerInterval);
            state.status = `üéâ You won in ${state.moves} moves and ${formatTime(state.time)}!`;
            
            if (state.gameMode === 'campaign' && !state.completedLevels.includes(state.campaignLevel)) {
                state.completedLevels.push(state.campaignLevel);
            }
        }
        
        // Get similar images
        const images = result.webDetection?.visuallySimilarImages || [];
        state.results = images.slice(0, 30);
        
        if (state.results.length === 0) {
            state.status = 'No similar images found. Try the lens tool!';
        } else {
            if (!state.gameWon) {
                state.status = `Found ${state.results.length} images. Click one to continue!`;
            }
        }
        
        render();
        
    } catch (error) {
        console.error('Analysis error:', error);
        state.status = 'Error analyzing image';
        render();
    }
}

async function handleImageClick(url) {
    if (state.gameWon) return;
    
    state.moves++;
    state.currentImage = url;
    state.results = [];
    state.status = 'Analyzing...';
    render();
    
    await analyzeCurrentImage();
}

function showGiveUpDialog() {
    state.showGiveUp = true;
    render();
}

function renderGiveUpDialog() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 border-2 border-gray-200">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Give Up?</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to end this game? Your progress won't be saved.</p>
            <div class="flex gap-3">
                <button onclick="confirmGiveUp()" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600">Yes, Give Up</button>
                <button onclick="cancelGiveUp()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300">Keep Playing</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function confirmGiveUp() {
    clearInterval(state.timerInterval);
    state.showGiveUp = false;
    showScreen('home');
}

function cancelGiveUp() {
    state.showGiveUp = false;
    render();
}

// Initialize
window.addEventListener('DOMContentLoaded', () => {
    const savedKey = localStorage.getItem('imgpath_api_key');
    if (savedKey) {
        state.apiKey = savedKey;
    }
    render();
});
    </script>
</body>
</html>